<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../../">
  <title data-ice="title">Kaetram-Open/server/js/main.js | Kaetram</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="A modern HTML5 multiplayer adventure!"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="Kaetram"><meta property="twitter:description" content="A modern HTML5 multiplayer adventure!"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  </ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">Kaetram-Open/server/js/main.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">let World = require(&apos;./game/world&apos;),
    WebSocket = require(&apos;./network/websocket&apos;),
    config = require(&apos;../config&apos;),
    Log = require(&apos;log&apos;),
    Parser = require(&apos;./util/parser&apos;),
    Database = require(&apos;./database/database&apos;),
    _ = require(&apos;underscore&apos;),
    worlds = [], allowConnections = false,
    worldsCreated = 0;

log = new Log(config.worlds &gt; 1 ? &apos;notice&apos; : config.debugLevel, config.localDebug ? fs.createWriteStream(&apos;runtime.log&apos;) : null);

function main() {
    log.info(&apos;Initializing &apos; + config.name + &apos; game engine...&apos;);

    let webSocket = new WebSocket(config.host, config.port, config.gver),
        database = new Database(config.database),
        stdin = process.openStdin();

    webSocket.onConnect(function(connection) {
        if (allowConnections) {
            let world;

            for (let i = 0; i &lt; worlds.length; i++)
                if (worlds[i].playerCount &lt; worlds[i].maxPlayers) {
                    world = worlds[i];
                    break;
                }

            if (world)
                world.playerConnectCallback(connection);
            else {
                log.info(&apos;Worlds are all currently full. Closing connection.&apos;);

                connection.sendUTF8(&apos;full&apos;);
                connection.close();
            }

        } else {
            connection.sendUTF8(&apos;disallowed&apos;);
            connection.close();
        }

    });


    webSocket.onWebSocketReady(function() {
        /**
         * Initialize the worlds after the webSocket finishes.
         */

        loadParser();

        for (let i = 0; i &lt; config.worlds; i++)
            worlds.push(new World(i + 1, webSocket, database.getDatabase()));

        initializeWorlds();

    });

    stdin.addListener(&apos;data&apos;, (data) =&gt; {
        let message = data.toString().replace(/(\r\n|\n|\r)/gm, &apos;&apos;),
            type = message.charAt(0);

        if (type !== &apos;/&apos;)
            return;

        let blocks = message.substring(1).split(&apos; &apos;),
            command = blocks.shift();

        if (!command)
            return;

        switch (command) {

            case &apos;players&apos;:
                let total = 0;

                _.each(worlds, (world) =&gt; {
                    total += world.playerCount;
                });

                log.info(`There are ${total} player(s) in ${worlds.length} world(s).`);

                break;

            case &apos;registered&apos;:

                worlds[0].database.registeredCount((count) =&gt; {
                    log.info(`There are ${count} users registered.`);
                });

                break;

        }
    });

}

function onWorldLoad() {
    worldsCreated++;
    if (worldsCreated === worlds.length)
        allWorldsCreated();
}

function allWorldsCreated() {
    log.notice(&apos;Finished creating &apos; + worlds.length + &apos; world&apos; + (worlds.length &gt; 1 ? &apos;s&apos; : &apos;&apos;) + &apos;!&apos;);
    allowConnections = true;

    var host = config.host === &apos;0.0.0.0&apos; ? &apos;localhost&apos; : config.host;
    log.notice(&apos;Connect locally via http://&apos; + host + &apos;:&apos; + config.port);
}

function loadParser() {
    new Parser();
}

function initializeWorlds() {
    for (var worldId in worlds)
        if (worlds.hasOwnProperty(worldId))
            worlds[worldId].load(onWorldLoad);
}

function getPopulations() {
    var counts = [];

    for (var index in worlds)
        if (worlds.hasOwnProperty(index))
            counts.push(worlds[index].getPopulation());

    return counts;
}

function saveAll() {
    _.each(worlds, function(world) {
        world.saveAll();
    });

    var plural = worlds.length &gt; 1;

    log.notice(&apos;Saved players for &apos; + worlds.length + &apos; world&apos; + (plural ? &apos;s&apos; : &apos;&apos;) + &apos;.&apos;);
}

if ( typeof String.prototype.startsWith !== &apos;function&apos; ) {
    String.prototype.startsWith = function(str) {
        return str.length &gt; 0 &amp;&amp; this.substring( 0, str.length ) === str;
    };
}

if ( typeof String.prototype.endsWith !== &apos;function&apos; ) {
    String.prototype.endsWith = function(str) {
        return str.length &gt; 0 &amp;&amp; this.substring( this.length - str.length, this.length ) === str;
    };
}

main();
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
