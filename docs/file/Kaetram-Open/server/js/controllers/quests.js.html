<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../../../">
  <title data-ice="title">Kaetram-Open/server/js/controllers/quests.js | kaetram</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="Kaetram is an open-source game-engine created to aid those interested in entering the game development realm. The codebase is simple, clean, and intuitive, and is intended to be used as a learning tool. The original idea is based off Little Workshop&apos;s demo game - BrowserQuest. The assets have remained the same, but the code itself has been completely wiped and redone from the ground up.Kaetram is an open-source game-engine created to aid those interested in entering the game development realm. The codebase is simple, clean, and intuitive, and is intended to be used as a learning tool. The original idea is based off Little Workshop&apos;s demo game - BrowserQuest. The assets have remained the same, but the code itself has been completely wiped and redone from the ground up."><meta property="twitter:card" content="summary"><meta property="twitter:title" content="kaetram"><meta property="twitter:description" content="Kaetram is an open-source game-engine created to aid those interested in entering the game development realm. The codebase is simple, clean, and intuitive, and is intended to be used as a learning tool. The original idea is based off Little Workshop&apos;s demo game - BrowserQuest. The assets have remained the same, but the code itself has been completely wiped and redone from the ground up.Kaetram is an open-source game-engine created to aid those interested in entering the game development realm. The codebase is simple, clean, and intuitive, and is intended to be used as a learning tool. The original idea is based off Little Workshop&apos;s demo game - BrowserQuest. The assets have remained the same, but the code itself has been completely wiped and redone from the ground up."></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/Veradictus/Kaetram-Open"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  </ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">Kaetram-Open/server/js/controllers/quests.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">/* global module */

let _ = require(&apos;underscore&apos;),
    Introduction = require(&apos;../game/entity/character/player/quest/impl/introduction&apos;),
    BulkySituation = require(&apos;../game/entity/character/player/quest/impl/bulkysituation&apos;),
    QuestData = require(&apos;../../data/quests.json&apos;),
    AchievementData = require(&apos;../../data/achievements.json&apos;),
    Achievement = require(&apos;../game/entity/character/player/achievement&apos;);

class Quests {
    constructor(player) {
        let self = this;

        self.player = player;

        self.quests = {};
        self.achievements = {};

        self.load();
    }

    load() {
        let self = this,
            questCount = 0;

        _.each(QuestData, quest =&gt; {
            if (questCount === 0)
                self.quests[quest.id] = new Introduction(self.player, quest);
            else if (questCount === 1)
                self.quests[quest.id] = new BulkySituation(self.player, quest);

            questCount++;
        });

        _.each(AchievementData, achievement =&gt; {
            self.achievements[achievement.id] = new Achievement(
                achievement.id,
                self.player
            );
        });
    }

    updateQuests(ids, stages) {
        let self = this;

        if (!ids || !stages) {
            _.each(self.quests, quest =&gt; {
                quest.load(0);
            });

            return;
        }

        for (let id = 0; id &lt; ids.length; id++) {
            if (!isNaN(parseInt(ids[id])) &amp;&amp; self.quests[id])
                self.quests[id].load(stages[id]);
        }

        if (self.questsReadyCallback) self.questsReadyCallback();
    }

    updateAchievements(ids, progress) {
        let self = this;

        for (let id = 0; id &lt; ids.length; id++) {
            if (!isNaN(parseInt(ids[id])) &amp;&amp; self.achievements[id])
                self.achievements[id].setProgress(progress[id]);
        }

        if (self.achievementsReadyCallback) self.achievementsReadyCallback();
    }

    getQuest(id) {
        let self = this;

        if (id in self.quests) return self.quests[id];

        return null;
    }

    getQuests() {
        let self = this,
            ids = &apos;&apos;,
            stages = &apos;&apos;;

        for (let id = 0; id &lt; self.getQuestSize(); id++) {
            let quest = self.quests[id];

            ids += id + &apos; &apos;;
            stages += quest.stage + &apos; &apos;;
        }

        return {
            username: self.player.username,
            ids: ids,
            stages: stages
        };
    }

    getAchievements() {
        let self = this,
            ids = &apos;&apos;,
            progress = &apos;&apos;;

        for (let id = 0; id &lt; self.getAchievementSize(); id++) {
            ids += id + &apos; &apos;;
            progress += self.achievements[id].progress + &apos; &apos;;
        }

        return {
            username: self.player.username,
            ids: ids,
            progress: progress
        };
    }

    getAchievementData() {
        let self = this,
            achievements = [];

        self.forEachAchievement(achievement =&gt; {
            achievements.push(achievement.getInfo());
        });

        return {
            achievements: achievements
        };
    }

    getQuestData() {
        let self = this,
            quests = [];

        self.forEachQuest(quest =&gt; {
            quests.push(quest.getInfo());
        });

        return {
            quests: quests
        };
    }

    forEachQuest(callback) {
        _.each(this.quests, quest =&gt; {
            callback(quest);
        });
    }

    forEachAchievement(callback) {
        _.each(this.achievements, achievement =&gt; {
            callback(achievement);
        });
    }

    getQuestsCompleted() {
        let self = this,
            count = 0;

        for (let id in self.quests) {
            if (self.quests.hasOwnProperty(id))
                if (self.quests[id].isFinished()) count++;
        }

        return count;
    }

    getAchievementsCompleted() {
        let self = this,
            count = 0;

        for (let id in self.achievements) {
            if (self.achievements.hasOwnProperty(id))
                if (self.achievements[id].isFinished()) count++;
        }

        return count;
    }

    getQuestSize() {
        return Object.keys(this.quests).length;
    }

    getAchievementSize() {
        return Object.keys(this.achievements).length;
    }

    getQuestByNPC(npc) {
        let self = this;

        /**
         * Iterate through the quest list in the order it has been
         * added so that NPC&apos;s that are required by multiple quests
         * follow the proper order.
         */

        for (let id in self.quests) {
            if (self.quests.hasOwnProperty(id)) {
                let quest = self.quests[id];

                if (quest.hasNPC(npc.id)) return quest;
            }
        }

        return null;
    }

    getAchievementByNPC(npc) {
        let self = this;

        for (let id in self.achievements) {
            if (self.achievements.hasOwnProperty(id)) {
                if (
                    self.achievements[id].data.npc === npc.id &amp;&amp;
                    !self.achievements[id].isFinished()
                )
                    return self.achievements[id];
            }
        }

        return null;
    }

    getAchievementByMob(mob) {
        let self = this;

        for (let id in self.achievements) {
            if (self.achievements.hasOwnProperty(id)) {
                if (self.achievements[id].data.mob === mob.id)
                    return self.achievements[id];
            }
        }

        return null;
    }

    isQuestMob(mob) {
        let self = this;

        for (let id in self.quests) {
            if (self.quests.hasOwnProperty(id)) {
                let quest = self.quests[id];

                if (!quest.isFinished() &amp;&amp; quest.hasMob(mob.id)) return true;
            }
        }
    }

    isAchievementMob(mob) {
        let self = this;

        for (let id in self.achievements) {
            if (self.achievements.hasOwnProperty(id)) {
                if (
                    self.achievements[id].data.mob === mob.id &amp;&amp;
                    !self.achievements[id].isFinished()
                )
                    return true;
            }
        }

        return false;
    }

    isQuestNPC(npc) {
        let self = this;

        for (let id in self.quests) {
            if (self.quests.hasOwnProperty(id)) {
                let quest = self.quests[id];

                if (!quest.isFinished() &amp;&amp; quest.hasNPC(npc.id)) return true;
            }
        }
    }

    isAchievementNPC(npc) {
        let self = this;

        for (let id in self.achievements) {
            if (self.achievements.hasOwnProperty(id)) {
                if (
                    self.achievements[id].data.npc === npc.id &amp;&amp;
                    !self.achievements[id].isFinished()
                )
                    return true;
            }
        }

        return false;
    }

    onAchievementsReady(callback) {
        this.achievementsReadyCallback = callback;
    }

    onQuestsReady(callback) {
        this.questsReadyCallback = callback;
    }
}

module.exports = Quests;
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
