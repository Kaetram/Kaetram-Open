<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../../../../../">
  <title data-ice="title">Kaetram-Open/client/js/entity/character/player/playerhandler.js | kaetram</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="Kaetram is an open-source game-engine created to aid those interested in entering the game development realm. The codebase is simple, clean, and intuitive, and is intended to be used as a learning tool. The original idea is based off Little Workshop&apos;s demo game - BrowserQuest. The assets have remained the same, but the code itself has been completely wiped and redone from the ground up."><meta property="twitter:card" content="summary"><meta property="twitter:title" content="kaetram"><meta property="twitter:description" content="Kaetram is an open-source game-engine created to aid those interested in entering the game development realm. The codebase is simple, clean, and intuitive, and is intended to be used as a learning tool. The original idea is based off Little Workshop&apos;s demo game - BrowserQuest. The assets have remained the same, but the code itself has been completely wiped and redone from the ground up."></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/Veradictus/Kaetram-Open"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  </ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">Kaetram-Open/client/js/entity/character/player/playerhandler.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">/* global log, Packets, Modules */

define(function() {
    /**
     * This is a player handler, responsible for all the callbacks
     * without having to clutter up the entire game file.
     */

    return Class.extend({

        init: function(game, player) {
            var self = this;

            self.game = game;
            self.camera = game.getCamera();
            self.input = game.input;
            self.player = player;
            self.entities = game.entities;
            self.socket = game.socket;
            self.renderer = game.renderer;

            self.load();
        },

        load: function() {
            var self = this;

            self.player.onRequestPath(function(x, y) {
                if (self.player.dead)
                    return null;

                var ignores = [self.player];

                if (self.player.hasTarget())
                    ignores.push(self.player.target);

                if (!self.game.map.isColliding(x, y))
                    self.socket.send(Packets.Movement, [Packets.MovementOpcode.Request, x, y, self.player.gridX, self.player.gridY]);

                return self.game.findPath(self.player, x, y, ignores);
            });

            self.player.onStartPathing(function(path) {
                var i = path.length - 1;

                self.input.selectedX = path[i][0];
                self.input.selectedY = path[i][1];
                self.input.selectedCellVisible = true;

                if (!self.game.getEntityAt(self.input.selectedX, self.input.selectedY))
                    self.socket.send(Packets.Target, [Packets.TargetOpcode.None]);

                self.socket.send(Packets.Movement, [Packets.MovementOpcode.Started, self.input.selectedX, self.input.selectedY, self.player.gridX, self.player.gridY]);
            });

            self.player.onStopPathing(function(x, y) {
                self.entities.unregisterPosition(self.player);
                self.entities.registerPosition(self.player);

                self.input.selectedCellVisible = false;

                self.camera.clip();

                var id = null,
                    entity = self.game.getEntityAt(x, y, true);

                if (entity)
                    id = entity.id;

                var hasTarget = self.player.hasTarget();

                self.socket.send(Packets.Movement, [Packets.MovementOpcode.Stop, x, y, id, hasTarget, self.player.orientation]);

                if (hasTarget) {
                    self.socket.send(Packets.Target, [self.isAttackable() ? Packets.TargetOpcode.Attack : Packets.TargetOpcode.Talk, self.player.target.id]);

                    self.player.lookAt(self.player.target);
                }

                self.input.setPassiveTarget();

                self.game.storage.setOrientation(self.player.orientation);
            });

            self.player.onBeforeStep(function() {
                self.entities.unregisterPosition(self.player);

                if (!self.isAttackable())
                    return;

                if (self.player.isRanged()) {
                    if (self.player.getDistance(self.player.target) &lt; 7)
                        self.player.stop();
                } else {
                    self.input.selectedX = self.player.target.gridX;
                    self.input.selectedY = self.player.target.gridY;
                }
            });

            self.player.onStep(function() {
                if (self.player.hasNextStep())
                    self.entities.registerDuality(self.player);

                if (!self.camera.centered || self.camera.lockX || self.camera.lockY)
                    self.checkBounds();

                self.player.forEachAttacker(function(attacker) {
                    if (!attacker.stunned)
                        attacker.follow(self.player);
                });

                self.socket.send(Packets.Movement, [Packets.MovementOpcode.Step, self.player.gridX, self.player.gridY]);
            });

            self.player.onSecondStep(function() {
                self.renderer.updateAnimatedTiles();
            });

            self.player.onMove(function() {
                /**
                 * This is a callback representing the absolute exact position of the player.
                 */

                if (self.camera.centered)
                    self.camera.centreOn(self.player);

                if (self.player.hasTarget())
                    self.player.follow(self.player.target);
            });

            self.player.onUpdateArmour(function(armourName) {
                self.player.setSprite(self.game.getSprite(armourName));
            });
        },

        isAttackable: function() {
            var self = this,
                target = self.player.target;

            if (!target)
                return;

            return target.type === &apos;mob&apos; || (target.type === &apos;player&apos; &amp;&amp; target.pvp);
        },

        checkBounds: function() {
            var self = this,
                x = self.player.gridX - self.camera.gridX,
                y = self.player.gridY - self.camera.gridY,
                isBorder = false;

            if (x === 0)
                self.game.zoning.setLeft();
            else if (y === 0)
                self.game.zoning.setUp();
            else if (x === self.camera.gridWidth - 1)
                self.game.zoning.setRight();
            else if (y === self.camera.gridHeight - 1)
                self.game.zoning.setDown();

            if (self.game.zoning.direction !== null) {
                self.camera.zone(self.game.zoning.getDirection());
                self.game.zoning.reset();
            }
        }

    });
});
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
